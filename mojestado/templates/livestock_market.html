{% extends "layout.html" %}
{% block content %}
<style>
    @media (max-width: 760px)  {
        .mobtable td:nth-of-type(1):before { content: "ID životinje"; }
        .mobtable td:nth-of-type(2):before { content: "Potkategorija"; }
        .mobtable td:nth-of-type(3):before { content: "Rasa"; }
        .mobtable td:nth-of-type(4):before { content: "Pol"; }
        .mobtable td:nth-of-type(5):before { content: "Trenutna masa"; }
        .mobtable td:nth-of-type(6):before { content: "Cena po kg (rsd)"; }
        .mobtable td:nth-of-type(7):before { content: "Ukupna (rsd)"; }
        .mobtable td:nth-of-type(8):before { content: "Osigurano"; }
        .mobtable td:nth-of-type(9):before { content: "Organsko"; }
        .mobtable td:nth-of-type(10):before { content: "Usluge"; }
        .mobtable td:nth-of-type(11):before { content: "Karton grla"; }
        .mobtable td:nth-of-type(12):before { content: "PG"; }
        .mobtable td:nth-of-type(13):before { content: "Lokacija"; }
    }
</style>
<section class="page-hero livestock-{{ animal_category_id }}">
    <div class="container">
        <div class="row">
            <div class="col-md-3"></div>
            <div class="col-md-6">
                <h1 class="wht-text">Živa vaga</h1>
                <div class="home-hero-txt mb-5">
                    Živa vaga je strana koja se odnosi na sva grla stoke i svu ostalu živinu, kako u tovu, tako i odmah u prodaji. 
                    Tu možete pronaći ponudu grla svih poljoprivrednih gazdinstava.
                </div>
            </div>
            <div class="col-md-3"></div>
        </div>
    </div>
</section>
<section class="zivavaga-page mt-5" id="waitDiv">
    <div class="container">
        {% if animal_category_id == 0 %}
        <div class="row moboverflow">
            <div class="container">
                <section class="logo-carousel slider" data-arrows="true">
                    {% for category in animal_categories %}
                    <div class="slide"><a href="{{ url_for('marketplace.livestock_market', animal_category_id=category.id) }}"><img src="{{ url_for('static', filename='images/' + category.animal_category_name + '.png') }}" alt="{{ category.animal_category_name }}"><p>{{ category.animal_category_name }}</p></a></div>
                    {% endfor %}
                </section>
            </div>
        </div>
        {% else %}
        <div class="row moboverflow">
            <div class="container">
                <section class="logo-carousel slider" data-arrows="true">
                    {% for category in animal_categories %}
                    <div class="slide"><a href="{{ url_for('marketplace.livestock_market', animal_category_id=category.id) }}"><img src="{{ url_for('static', filename='images/' + category.animal_category_name + '.png') }}" alt="{{ category.animal_category_name }}"><p>{{ category.animal_category_name }}</p></a></div>
                    {% endfor %}
                </section>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2 sidebar">
                <form id='livestock' action="{{url_for('marketplace.livestock_market', animal_category_id=animal_category_id)}}" method="POST">
                    <!--<h2>Filteri</h2>-->
                    <div class="card mb-3">
                        <div class="card-header">
                            Lokacija
                        </div>
                        <div class="card-body">
                            <select class="form-select mb-2" id="municipality" name="municipality">
                            <option value="0">Sve lokacije</option>
                            {% for municipality in municipality_filter_list %}
                                <option value="{{municipality.id}}">{{municipality.municipality_name}}</option>
                            {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">
                            Potkategorije
                        </div>
                        <div class="card-body">
                            {% for subcategory in animal_subcategories %}
                            <div class="form-check form-switch">
                                {% if subcategory.id in active_subcategories %}
                                <input class="form-check-input subcategory-filter" type="checkbox" id="subcategory_{{subcategory.id}}" name="subcategory_{{subcategory.id}}" checked>
                                {% else %}
                                <input class="form-check-input subcategory-filter" type="checkbox" id="subcategory_{{subcategory.id}}" name="subcategory_{{subcategory.id}}">
                                {% endif %}
                                <label class="form-check-label" for="subcategory_{{subcategory.id}}">{{subcategory.subcategory}}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% if weight_filter %}
                    <div class="card mb-3">
                        <div class="card-header">
                            Masa
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch">
                                {% for mass_filter in mass_filters %}
                                <input class="form-check-input" type="checkbox" id="subcategory_{{mass_filter}}" name="subcategory_{{mass_filter}}">
                                <label class="form-check-label" for="subcategory_{{mass_filter}}">{{mass_filter}}</label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="card mb-3">
                        <div class="card-header">
                            Organska proizvodnja
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="organic_filter" name="organic_filter">
                                <label class="form-check-label" for="organic_filter">Organski</label>
                                <a href="https://sr.wikipedia.org/sr/Organska_poljoprivreda" target="_blank" data-bs-toggle="tooltip" data-bs-placement="right" title="Detaljnije o organskoj proizvodnji">
                                    <i class="fas fa-question-circle"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">
                            Osigurana grla
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="insure_filter" name="insure_filter">
                                <label class="form-check-label" for="insure_filter">Osigurano</label>
                            </div>
                        </div>
                    </div>
                    <!-- <div class="card mb-3">
                        <div class="card-header">
                            Količina
                        </div>
                        <div class="card-body">
                            <div class="">
                                <label class="form-label" for="quantity_filter">Količina</label>
                                <input class="form-range" type="range" min="0" max="5" id="quantity_filter" name="quantity_filter">
                            </div>
                        </div>
                    </div> -->
                </form>
            </div>
            <div class="col-md-10 table-overflow">
                <p>Kategorija:</p>
                <h2>{{ animal_category.animal_category_name }}</h2>
                <table class="table table-striped mobtable">
                    <thead>
                        <tr>
                            <th>ID životinje</th>
                            <th>Potkategorija</th>
                            <th>Rasa</th>
                            <th>Pol</th>
                            <th>Trenutna masa</th>
                            <th>Cena po kg (rsd)</th>
                            <th>Ukupna (rsd)</th>
                            <th>Osigurano</th>
                            <th>Organsko</th>
                            <th>Usluge</th>
                            <th>Karton<br>grla</th>
                            <th>PG</th>
                            <th>Lokacija</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for animal in animals %}
                        <tr>
                            <td>
                            {% if animal.animal_id %}
                                {{ animal.animal_id }}
                            {% endif %}
                            </td>
                            <td>{{ animal.animal_categorization.subcategory }}</td>
                            <td>{{ animal.animal_race.animal_race_name }}</td>
                            <td>{{ animal.animal_gender }}</td>
                            <td>{{ "{:.2f}".format(animal.current_weight) }}</td>
                            <td>{{ "{:.2f}".format(animal.price_per_kg) }}</td>
                            <td>{{ "{:.2f}".format(animal.total_price) }}</td>
                            <td>
                                {% if animal.insured %}
                                    Osigurano
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if animal.organic_animal %}
                                    Organsko
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% for service, category in animal.farm_animal.services.items() %}
                                    {% for category_id, price in category.items() %}
                                        {% if price | float > 0 and category_id | int == animal.animal_category.id %}
                                            {% if service == 'klanje' %}
                                                <img src="{{ url_for('static', filename='images/klanje-icon.png') }}" alt="Usluga klanja" width="32" height="32">
                                            {% elif service == 'obrada' %}
                                                <img src="{{ url_for('static', filename='images/obrada-icon.png') }}" alt="Usluga obrade" width="32" height="32">
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            </td>
                            <td>
                                {% if animal.cardboard %}
                                <a href="{{ url_for('static', filename='cardboards/' + animal.cardboard) }}" target="_blank" rel="noopener noreferrer" class="btn btn-primary9"><i class="fa-regular fa-clipboard"></i></a>
                                {% endif %}
                            </td>
                            <td><a href="{{ url_for('farms.farm_detail', farm_id=animal.farm_id) }}">{{ animal.farm_animal.farm_name }}</a></td>
                            <td>{{ animal.farm_animal.farm_city }}</td>
                            <td>
                                {% if animal.farm_animal.user_id != current_user.id %}
                                    {% set services = animal.farm_animal.services %}
                                    {% set klanje_value = services['klanje'].get(animal_category_id|string)|int if services and services.get('klanje') else 0 %}
                                    {% set obrada_value = services['obrada'].get(animal_category_id|string)|int if services and services.get('obrada') else 0 %}

                                    {% if services and services.get('klanje') and services['klanje'].get(animal_category_id|string) and services['klanje'][animal_category_id|string]|int > 0 %}
                                        <button class="btn btn-primary services-btn" data-bs-toggle="modal" data-bs-target="#servicesModal"
                                                data-animal-id="{{ animal.id }}"
                                                data-klanje-value="{{ klanje_value }}"
                                                data-obrada-value="{{ obrada_value }}">Kupi</button>
                                    {% else %}
                                        <a class="btn btn-primary services-btn" href="{{ url_for('main.add_animal_to_cart', animal_id=animal.id)}}">Kupi</a>
                                    {% endif %}
                                    {% if animal.intended_for == "tov" %}
                                        {% if services and services.get('klanje') and services['klanje'].get(animal_category_id|string) and services['klanje'][animal_category_id|string]|int > 0 %}
                                            <button class="btn tov-btn" data-bs-toggle="modal" data-bs-target="#tovModal" data-animal-id="{{ animal.id }}" data-current-weight="{{ animal.current_weight }}">Tov</button>
                                        {% else %}
                                            <button class="btn tov-btn" data-bs-toggle="modal" data-bs-target="#tovModal_" data-animal-id="{{ animal.id }}" data-current-weight="{{ animal.current_weight }}">Tov</button>
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                    moja životinja
                                {% endif %}
                            </td>
                            
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
            </div>
        </div>
        <!-- Tov Modal -->
        <div class="modal fade" id="tovModal" tabindex="-1" aria-labelledby="tovModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="tovModalLabel">Detalji tova</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="tovForm" action="{{ url_for('main.add_fattening_to_chart') }}" method="POST">
                            <input type="hidden" id="animalId" name="animalId">
                            <div class="mb-3">
                                <label for="currentWeight" class="form-label">Trenutna masa (kg)</label>
                                <input type="number" class="form-control" id="currentWeight" name="currentWeight" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="desiredWeight" class="form-label">Željena masa (kg)</label>
                                <input type="number" class="form-control" id="desiredWeight" name="desiredWeight" required>
                            </div>
                            <div class="mb-3">
                                <label for="calculatedPrice" class="form-label">Preračunata cena tova (RSD)</label>
                                <input type="number" class="form-control" id="calculatedPrice" name="calculatedPrice" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="feedingDays" class="form-label">Preračunat broj hranidbenih dana</label>
                                <input type="number" class="form-control" id="feedingDays" name="feedingDays" readonly>
                            </div>
                            <div class="mb-3 form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="installmentPayment" name="installmentPayment">
                                <label class="form-check-label" for="installmentPayment">Plaćanje na rate</label>
                            </div>
                            <div class="mb-3" id="installmentOptionsDiv" style="display: none;">
                                <label for="installmentOptions" class="form-label">Broj rata</label>
                                <select class="form-select" id="installmentOptions" name="installmentOptions">
                                    <!-- Options will be dynamically populated -->
                                </select>
                            </div>
                            <p>Za ovu životinju poljoprivredno gazdinstvo pruža sledeće usluge:</p>
                            
                            <!-- Klanje usluga -->
                            <div class="mb-3 form-check" id="slaughterServiceWrapper">
                                <input type="checkbox" class="form-check-input" id="slaughterService" name="slaughterService">
                                <label class="form-check-label" for="slaughterService">Klanje</label>
                            </div>
                            <!-- Obrada usluga -->
                            <div class="mb-3 form-check" id="processingServiceWrapper">
                                <input type="checkbox" class="form-check-input" id="processingService" name="processingService">
                                <label class="form-check-label" for="processingService">
                                    Obrada
                                </label>
                                <span class="info-box"><i class="fa-solid fa-info"></i>
                                    <span class="tooltip">
                                        {% if animal_category_id == 1 %}
                                        <p>Francuska obrada: svinjski but, svinjska plećka, kremenadla, vrat, las kare.</p>
                                        <p>Milanez: but, kremenadla.</p>
                                        {% elif animal_category_id == 2 %}
                                        <p>Čerek: prednji čerek (vrat sk, vrat bk, potplećka sk, potplećka bk, plećka sk, plećka bk, pauflek, rebra sk, grudi) i zadnji čerek (rozbratna sk, but sk, juneći biftek, ramstek).</p>
                                        {% elif animal_category_id == 3 %}
                                        <p>Čerek: prednjiček (vrat sk, vrat bk, potplećka sk, potplećka bk, plećka sk, plećka bk, pauflek, rebra sk, grudi) i zadnjiček (rozbratna sk, but sk, juneći biftek, ramstek).</p>
                                        {% endif %}
                                    </span>
                                </span>
                            </div>
                            <button type="submit" class="btn btn-primary">Potvrdi tov</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Tov_ Modal -->
        <div class="modal fade" id="tovModal_" tabindex="-1" aria-labelledby="tovModalLabel_" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="tovModalLabel_">Detalji tova</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="tovForm_" action="{{ url_for('main.add_fattening_to_chart') }}" method="POST">
                            <input type="hidden" id="animalId_" name="animalId_">
                            <div class="mb-3">
                                <label for="currentWeight_" class="form-label">Trenutna masa (kg)</label>
                                <input type="number" class="form-control" id="currentWeight_" name="currentWeight_" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="desiredWeight_" class="form-label">Željena masa (kg)</label>
                                <input type="number" class="form-control" id="desiredWeight_" name="desiredWeight_" required>
                            </div>
                            <div class="mb-3">
                                <label for="calculatedPrice_" class="form-label">Preračunata cena tova (RSD)</label>
                                <input type="number" class="form-control" id="calculatedPrice_" name="calculatedPrice_" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="feedingDays_" class="form-label">Preračunat broj hranidbenih dana</label>
                                <input type="number" class="form-control" id="feedingDays_" name="feedingDays_" readonly>
                            </div>
                            <div class="mb-3 form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="installmentPayment_" name="installmentPayment_">
                                <label class="form-check-label" for="installmentPayment_">Plaćanje na rate</label>
                            </div>
                            <div class="mb-3" id="installmentOptionsDiv_" style="display: none;">
                                <label for="installmentOptions_" class="form-label">Broj rata</label>
                                <select class="form-select" id="installmentOptions_" name="installmentOptions_">
                                    <!-- Options will be dynamically populated -->
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Potvrdi tov</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Services Modal -->
        <div class="modal fade" id="servicesModal" tabindex="-1" aria-labelledby="servicesModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="servicesModalLabel">Kupovina Usluga</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="servicesForm" action="{{ url_for('main.add_services_to_chart') }}" method="POST">
                            <input type="hidden" id="serviceAnimalId" name="animalId">
                            <p>Za ovu životinju poljoprivredno gazdinstvo pruža sledeće usluge:</p>
                            
                            <!-- Klanje usluga -->
                            <div class="mb-3 form-check" id="slaughterServiceWrapper">
                                <input type="checkbox" class="form-check-input" id="slaughterService" name="slaughterService">
                                <label class="form-check-label" for="slaughterService">Klanje</label>
                            </div>
                            
                            <!-- Obrada usluga -->
                            <div class="mb-3 form-check" id="processingServiceWrapper">
                                <input type="checkbox" class="form-check-input" id="processingService" name="processingService">
                                <label class="form-check-label" for="processingService">
                                    Obrada
                                </label>
                                <span class="info-box"><i class="fa-solid fa-info"></i>
                                    <span class="tooltip">
                                        {% if animal_category_id == 1 %}
                                        <p>Francuska obrada: svinjski but, svinjska plećka, kremenadla, vrat, las kare.</p>
                                        <p>Milanez: but, kremenadla.</p>
                                        {% elif animal_category_id == 2 %}
                                        <p>Čerek: prednji čerek (vrat sk, vrat bk, potplećka sk, potplećka bk, plećka sk, plećka bk, pauflek, rebra sk, grudi) i zadnji čerek (rozbratna sk, but sk, juneći biftek, ramstek).</p>
                                        {% elif animal_category_id == 3 %}
                                        <p>Čerek: prednjiček (vrat sk, vrat bk, potplećka sk, potplećka bk, plećka sk, plećka bk, pauflek, rebra sk, grudi) i zadnjiček (rozbratna sk, but sk, juneći biftek, ramstek).</p>
                                        {% endif %}
                                    </span>
                                </span>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Kupi</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>
{% endblock content %}
{% block scripts %}
<script>
    $(document).ready(function() {
        $("#municipality").select2({
            multiple: true,
            closeOnSelect: false,
            placeholder: "Pretraži lokacije",
            allowClear: true,
            dropdownAutoWidth: true,
            width: '100%',
            theme: "classic"
        });

        // Preselektuj izabrane opcije
        var selectedValues = JSON.parse('{{ selected_municipality | safe }}');
        var organic_filter = JSON.parse('{{ organic_filter | safe }}');
        var insure_filter = JSON.parse('{{ insure_filter | safe }}');
        console.log(selectedValues);
        $("#municipality").val(selectedValues).trigger('change');
        $("#organic_filter").prop('checked', organic_filter);
        $("#insure_filter").prop('checked', insure_filter);
    });
    $(document).ready(function() {
        $('#municipality').change(function() {
            // post form
            $('#livestock').submit();
        });
    });
    $(document).ready(function() {
        $('#organic_filter').change(function() {
            // post form
            $('#livestock').submit();
        });
    });
    $(document).ready(function() {
        $('#insure_filter').change(function() {
            // post form
            $('#livestock').submit();
        });
        $('.subcategory-filter').change(function() {
            $('#livestock').submit();
        });
    });
    $(document).ready(function() {
        // Tov_ modal functionality - farma ne pruža usluge
        $('.tov-btn_').click(function() {
            var animalId = $(this).data('animal-id');
            var currentWeight = $(this).data('current-weight');
            
            $('#animalId_').val(animalId);
            $('#currentWeight_').val(currentWeight);

            // Reset form
            $('#tovForm_')[0].reset();
            $('#currentWeight_').val(currentWeight);
            $('#installmentOptionsDiv_').hide();
            $('#installmentPayment_').prop('disabled', true);
            // Dodajemo ovu liniju da onemogućimo dugme "Potvrdi tov" pri otvaranju modala
            $('#tovForm_ button[type="submit"]').prop('disabled', true);
            
            // Resetujemo polja za izračunate vrednosti
            $('#calculatedPrice_').val('');
            $('#feedingDays_').val('');
            $('#desiredWeight_').val('');
        })

        $('#desiredWeight_').on('input', function() {
            calculateTovDetails_();
            updateConfirmButton_();
        });

        $('#installmentPayment_').change(function() {
            if ($(this).is(':checked')) {
                $('#installmentOptionsDiv_').show();
                populateInstallmentOptions_();
            } else {
                $('#installmentOptionsDiv_').hide();
            }
        });

        // Tov modal functionality - farma pruža usluge
        $('.tov-btn').click(function() {
            var animalId = $(this).data('animal-id');
            var currentWeight = $(this).data('current-weight');
            
            $('#animalId').val(animalId);
            $('#currentWeight').val(currentWeight);
            
            // Reset form
            $('#tovForm')[0].reset();
            $('#currentWeight').val(currentWeight);
            $('#installmentOptionsDiv').hide();
            $('#installmentPayment').prop('disabled', true);
            // Dodajemo ovu liniju da onemogućimo dugme "Potvrdi tov" pri otvaranju modala
            $('#tovForm button[type="submit"]').prop('disabled', true);
            
            // Resetujemo polja za izračunate vrednosti
            $('#calculatedPrice').val('');
            $('#feedingDays').val('');
            $('#desiredWeight').val('');
        });

        $('#desiredWeight').on('input', function() {
            calculateTovDetails();
            updateConfirmButton();
        });

        $('#installmentPayment').change(function() {
            if ($(this).is(':checked')) {
                $('#installmentOptionsDiv').show();
                populateInstallmentOptions();
            } else {
                $('#installmentOptionsDiv').hide();
            }
        });

        function calculateTovDetails_() {
            var animalId = $('#animalId_').val();
            var currentWeight = parseFloat($('#currentWeight_').val());
            var desiredWeight = parseFloat($('#desiredWeight_').val());
            
            if (desiredWeight > currentWeight) {
                // AJAX poziv ka backend-u
                $.ajax({
                    url: "{{ url_for('animals.calculate_fattening_details') }}",
                    method: "POST",
                    data: {
                        animalId: animalId,
                        currentWeight: currentWeight,
                        desiredWeight: desiredWeight
                    },
                    success: function(response) {
                        $('#calculatedPrice_').val(response.fattening_price.toFixed(2));
                        $('#feedingDays_').val(response.number_of_fattening_days);
                        
                        // Omogući/onemogući switch za plaćanje na rate na osnovu broja dana hranjenja
                        var feedingDays = parseInt(response.number_of_fattening_days);
                        if (feedingDays >= 60) {
                            $('#installmentPayment_').prop('disabled', false);
                        } else {
                            disableInstallmentPayment_();
                        }
                        
                        populateInstallmentOptions_();
                    },
                    error: function(xhr, status, error) {
                        console.error("Greška pri izračunavanju detalja tova:", error);
                        resetTovDetails_();
                    }
                });
            } else {
                resetTovDetails_();
            }
            updateConfirmButton_();
        }
        function calculateTovDetails() {
            var animalId = $('#animalId').val();
            var currentWeight = parseFloat($('#currentWeight').val());
            var desiredWeight = parseFloat($('#desiredWeight').val());
            
            if (desiredWeight > currentWeight) {
                // AJAX poziv ka backend-u
                $.ajax({
                    url: "{{ url_for('animals.calculate_fattening_details') }}",
                    method: "POST",
                    data: {
                        animalId: animalId,
                        currentWeight: currentWeight,
                        desiredWeight: desiredWeight
                    },
                    success: function(response) {
                        $('#calculatedPrice').val(response.fattening_price.toFixed(2));
                        $('#feedingDays').val(response.number_of_fattening_days);
                        
                        // Omogući/onemogući switch za plaćanje na rate na osnovu broja dana hranjenja
                        var feedingDays = parseInt(response.number_of_fattening_days);
                        if (feedingDays >= 60) {
                            $('#installmentPayment').prop('disabled', false);
                        } else {
                            disableInstallmentPayment();
                        }
                        
                        populateInstallmentOptions();
                    },
                    error: function(xhr, status, error) {
                        console.error("Greška pri izračunavanju detalja tova:", error);
                        resetTovDetails();
                    }
                });
            } else {
                resetTovDetails();
            }
            updateConfirmButton();
        }

        function disableInstallmentPayment_() {
            $('#installmentPayment_').prop('disabled', true);
            $('#installmentPayment_').prop('checked', false);
            $('#installmentOptionsDiv_').hide();
        }
        function disableInstallmentPayment() {
            $('#installmentPayment').prop('disabled', true);
            $('#installmentPayment').prop('checked', false);
            $('#installmentOptionsDiv').hide();
        }

        function resetTovDetails_() {
            $('#calculatedPrice_').val('');
            $('#feedingDays_').val('');
            $('#installmentOptions_').empty();
            disableInstallmentPayment_();
        }
        function resetTovDetails() {
            $('#calculatedPrice').val('');
            $('#feedingDays').val('');
            $('#installmentOptions').empty();
            disableInstallmentPayment();
        }
        function updateConfirmButton_() {
            var currentWeight = parseFloat($('#currentWeight_').val());
            var desiredWeight = parseFloat($('#desiredWeight_').val());
            var confirmButton = $('#tovForm_ button[type="submit"]');

            if (isNaN(desiredWeight) || desiredWeight <= currentWeight) {
                confirmButton.prop('disabled', true);
            } else {
                confirmButton.prop('disabled', false);
            }
        }
        function updateConfirmButton() {
            var currentWeight = parseFloat($('#currentWeight').val());
            var desiredWeight = parseFloat($('#desiredWeight').val());
            var confirmButton = $('#tovForm button[type="submit"]');

            if (isNaN(desiredWeight) || desiredWeight <= currentWeight) {
                confirmButton.prop('disabled', true);
            } else {
                confirmButton.prop('disabled', false);
            }
        }
        // Dodajemo ovu liniju da onemogućimo dugme "Potvrdi tov" pri učitavanju stranice
        $('#tovForm_ button[type="submit"]').prop('disabled', true);
        $('#tovForm button[type="submit"]').prop('disabled', true);

        // Inicijalno onemogući dugme Potvrdi
        updateConfirmButton();
        updateConfirmButton_();

        function populateInstallmentOptions_() {
            var feedingDays = parseInt($('#feedingDays_').val());
            var maxInstallments = Math.floor(feedingDays / 30);
            var $select = $('#installmentOptions_');
            
            $select.empty();
            
            for (var i = 2; i <= maxInstallments; i++) {
                $select.append($('<option></option>').val(i).text(i));
            }
        }
        function populateInstallmentOptions() {
            var feedingDays = parseInt($('#feedingDays').val());
            var maxInstallments = Math.floor(feedingDays / 30);
            var $select = $('#installmentOptions');
            
            $select.empty();
            
            for (var i = 2; i <= maxInstallments; i++) {
                $select.append($('<option></option>').val(i).text(i));
            }
        }

    });
    $(document).ready(function() {
        // Services modal functionality
        $('.services-btn').click(function() {
            var animalId = $(this).data('animal-id');
            var klanjeValue = $(this).data('klanje-value');
            var obradaValue = $(this).data('obrada-value');
            
            // Set animalId in the hidden input
            $('#serviceAnimalId').val(animalId);
            
            // Reset form and hide all options initially
            $('#servicesForm')[0].reset();
            $('#slaughterServiceWrapper').hide();
            $('#processingServiceWrapper').hide();

            // Show options based on values
            if (klanjeValue > 0) {
                $('#slaughterServiceWrapper').show();
            }
            if (obradaValue > 0) {
                $('#processingServiceWrapper').show();
            }
        });

        // Handling the relationship between the checkboxes - animal
        $('#processingService').change(function() {
            console.log('processingService promenjen');
            if (this.checked) {
                console.log('processingService čekiran');
                // If "Obrada" is checked, ensure "Klanje" is also checked
                $('#slaughterService').prop('checked', true);
            }
        });
    
        $('#slaughterService').change(function() {
            console.log('slaughterService promenjen');
            if (!this.checked) {
                console.log('slaughterService dečekiran');
                // If "Klanje" is unchecked, ensure "Obrada" is also unchecked
                $('#processingService').prop('checked', false);
            }
        });
        // Handling the relationship between the checkboxes - fattening
        $('#processingService_').change(function() {
            console.log('processingService_____ promenjen');
            if (this.checked) {
                console.log('processingService_____ čekiran');
                // If "Obrada" is checked, ensure "Klanje" is also checked
                $('#slaughterService_').prop('checked', true);
            }
        });
    
        $('#slaughterService_').change(function() {
            console.log('slaughterService_____ promenjen');
            if (!this.checked) {
                console.log('slaughterService_____ dečekiran');
                // If "Klanje" is unchecked, ensure "Obrada" is also unchecked
                $('#processingService_').prop('checked', false);
            }
        });
    });
</script>

{% endblock scripts %}