{% extends "layout.html" %}
{% block content %}
{% if user.user_type == 'farm_active' %}
<section class="register-page firstsection mb-5">
    <div class="container">
        <div class="row">
            <nav class="navbar-expand-lg navbar-light my-navbar pb-10">
                <button class="navbar-toggler collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav2" aria-controls="navbarNav2" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                {% if current_user.user_type != 'admin' and current_user.id == farm.user_id %}
                <div class="collapse navbar-collapse" id="navbarNav2">
                    <ul class="navbar-nav">
                        <li class="nav-item active">
                            <a class="nav-link" href="{{ url_for('users.my_profile', user_id=user.id) }}">Moji podaci</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('users.my_farm', farm_id=farm.id) }}">Moja farma</a>
                        </li>
                        {% if farm_profile_completed %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('users.my_flock', farm_id=farm.id) }}">Moje stado</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('users.my_market', farm_id=farm.id) }}">Moja prodavnica</a>
                        </li>
                        {% else %}
                        <p>Nekompletiran profil!</p>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
            </nav>
        </div>
    </div>
</section>
{% endif %}
<section class="farm-page firstsection mb-5">
    <div class="container">
        <!-- Prvi red - slajder i osnovni podaci o proizvodu -->
        <div class="row">
            <!-- Slajder slika proizvoda -->
            <div id="myCarousel" class="carousel slide col-md-6" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for product_image in product.product_image_collection %}
                        <div class="carousel-item {% if loop.index == 1 %}active{% endif %}">
                            <img src="/static/product_image/{{ product_image }}" class="d-block w-100" alt="Slika proizvoda {{ product.product_name }}">
                        </div>
                    {% endfor %}
                </div>
                {% if product.product_image_collection|length > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#myCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#myCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                {% endif %}
            </div>
            
            <!-- Osnovni podaci o proizvodu -->
            <div class="col-md-6">
                <div class="col-md-12 mb-4">
                    <h1 class="mb-3">{{product.product_name}}</h1>
                    
                    <!-- Kategorija proizvoda -->
                    <p class="text-muted small mb-3">
                        <a href="{{ url_for('marketplace.products_market', product_category_id=product.product_category_id) }}" class="text-decoration-none">{{ product.product_category.product_category_name }}</a> &gt; 
                        {{ product.product_subcategory.product_subcategory_name }} &gt; 
                        {{ product.product_section.product_section_name }}
                    </p>
                    
                    <!-- Opis proizvoda -->
                    <div class="mb-3">
                        <p><strong>Opis: </strong>{{product.product_description}}</p>
                    </div>
                    
                    <!-- Glavne informacije o proizvodu -->
                    <div class="card border-light mb-3">
                        <div class="card-body">
                            <!-- Jedinica mere -->
                            <p class="mb-2"><strong>Jedinica mere: </strong>{{product.unit_of_measurement}}</p>
                            
                            <!-- Cene -->
                            {% if current_user.id == product.farm_product.user_farm.id %}
                            <p class="mb-2 fs-5"><strong>Cena po jedinici mere: </strong><span class="text-primary">{{"{:.2f}".format(product.product_price_per_unit_farmer)}} rsd/{{product.unit_of_measurement}}</span></p>
                            <p class="text-muted small"><strong>Cena po kg: </strong>{{"{:.2f}".format(product.product_price_per_kg / 1.38)}} rsd/kg</p>
                            {% else %}
                            <p class="mb-2 fs-5"><strong>Cena po jedinici mere: </strong><span class="text-primary">{{"{:.2f}".format(product.product_price_per_unit)}} rsd/{{product.unit_of_measurement}}</span></p>
                            <p class="text-muted small"><strong>Cena po kg: </strong>{{"{:.2f}".format(product.product_price_per_kg)}} rsd/kg</p>
                            {% endif %}
                            
                            <!-- Raspoloživa količina -->
                            <p class="mb-2"><strong>Raspoloživa količina: </strong>{{product.quantity}} {{product.unit_of_measurement}}</p>
                            
                            <!-- Organska proizvodnja -->
                            {% if product.organic_product %}
                            <div class="mt-2 badge bg-success p-2">Organska proizvodnja</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                {% if current_user.id != product.farm_product.user_farm.id %}
                <div class="col-md-12">
                    <form action="{{ url_for('main.add_product_to_cart', product_id=product.id) }}" method="POST" class="addtocart">
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <div class="form-group">
                            <label for="quantity">Količina</label>
                            <input type="number" name="quantity" value="1" class="form-control" min="1" max="{{ product.quantity }}" placeholder="maksimalno: {{ product.quantity }}">
                        </div>
                        <button type="submit" class="btn btn-primary">Kupi</button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>

        {% if current_user.id == product.farm_product.user_farm.id %}
        <!-- Drugi red - izmena proizvoda i upravljanje slikama -->
        <div class="row mt-4">
            <!-- Leva kolona - Upravljanje slikama -->
            <div class="col-md-6">
                <!-- Objedinjena sekcija za upravljanje slikama -->
                <div class="card p-4 h-100">
                    <h4 class="mb-3">Upravljanje slikama proizvoda</h4>
                    
                    <!-- Sekcija za dodavanje slika -->
                    <div class="mb-4">
                        <h5 class="mb-2">Dodavanje slike proizvoda</h5>
                        <p class="small">Možete dodati maksimalno 5 slika.</p>
                        <form action="{{ url_for('marketplace.upload_product_image', product_id=product.id) }}" method="POST" enctype="multipart/form-data" id="upload_form">
                            <input type="hidden" name="product_id" value="product.id">
                            <div class="form-group">
                                <div class="mb-2">
                                    <label for="picture" class="form-label">Izaberi sliku</label>
                                    <input type="file" class="form-control" id="picture" name="picture" accept="image/jpeg, image/png, image/gif, image/webp" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Dodaj sliku proizvoda</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Prikaz slika sa dugmićima za brisanje i postavljanje naslovne slike -->
                    <div>
                        <h5 class="mb-3">Pregled i upravljanje slikama</h5>
                        <div class="row">
                            {% for product_image in product.product_image_collection %}
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="image-wrapper" style="height: 150px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                        <img src="/static/product_image/{{ product_image }}" class="img-fluid" alt="Slika proizvoda {{ product.product_name }}" style="object-fit: cover; width: 100%; height: 100%;">
                                    </div>
                                    <div class="card-body p-2 text-center">
                                        <div class="d-flex flex-column gap-2">
                                            <form action="{{ url_for('marketplace.delete_product_image') }}" method="POST" class="mb-1">
                                                <input type="hidden" name="product_id" value="{{ product.id }}">
                                                <button type="submit" class="btn btn-danger btn-sm w-100" name="product_image" value="{{ product_image }}">Obriši sliku</button>
                                            </form>
                                            <form action="{{ url_for('marketplace.default_product_image') }}" method="POST">
                                                <input type="hidden" name="product_id" value="{{ product.id }}">
                                                <button type="submit" class="btn btn-primary btn-sm w-100" name="product_image" value="{{ product_image }}">Postavi kao naslovnu</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <!-- Desna kolona - Izmena gotovog proizvoda -->
            <div class="col-md-6">
                <!-- Sekcija za izmenu gotovog proizvoda -->
                <div class="card p-4 h-100">
                    <h4 class="mb-3">Izmena gotovog proizvoda</h4>
                    <form action="{{ url_for('marketplace.edit_product', product_id=product.id) }}" method="POST">
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <div class="row">
                            <div class="form-group mb-3">
                                <label for="product_name">Naziv proizvoda</label>
                                <input type="text" name="product_name" value="{{ product.product_name }}" class="form-control">
                            </div>
                            <div class="form-group mb-3">
                                <label for="product_description">Opis proizvoda</label>
                                <input type="text" name="product_description" value="{{ product.product_description }}" class="form-control">
                            </div>
                            
                            <!-- Dve kolone za organizaciju polja -->
                            <div class="row">
                                <!-- Leva strana - jedinica mere, Težina jedinice mere u kg, cena -->
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="unit_of_measurement">Jedinica mere</label>
                                        <select name="unit_of_measurement" id="unit_of_measurement" class="form-select width-auto">
                                            <option value="kg" {% if product.unit_of_measurement == 'kg' %}selected{% endif %}>kg</option>
                                            <option value="kom" {% if product.unit_of_measurement == 'kom' %}selected{% endif %}>kom</option>
                                            <option value="l" {% if product.unit_of_measurement == 'l' %}selected{% endif %}>l</option>
                                        </select>
                                    </div>
                                    <div class="form-group mb-3" id="conversion_field">
                                        <label for="weight_conversion">Težina jedinice mere u kg</label>
                                        <input type="number" step="0.05" name="weight_conversion" id="weight_conversion" value="{{ product.weight_conversion }}" class="form-control width-auto">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="product_price_per_unit">Cena po jedinici mere</label>
                                        <input type="number" step="1" name="product_price_per_unit" value="{{ product.product_price_per_unit_farmer }}" class="form-control width-auto">
                                    </div>
                                </div>
                                
                                <!-- Desna strana - organska proizvodnja, količina, dugme -->
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3 ml-2">
                                        {% if product.organic_product %}
                                        <input class="form-check-input" name="organic_product" type="checkbox" checked>
                                        {% else %}
                                        <input class="form-check-input" name="organic_product" type="checkbox">
                                        {% endif %}
                                        <label class="form-check-label" for="organic_product">Organska proizvodnja</label>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="quantity">Raspoloživa količina</label>
                                        <input type="number" name="quantity" value="{{ product.quantity }}" class="form-control width-auto">
                                    </div>
                                    <div class="form-group mt-4">
                                        <button type="submit" class="btn btn-primary">Sačuvaj</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- JavaScript za zavisnost polja konverzije od jedinice mere -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const unitOfMeasurementSelect = document.getElementById('unit_of_measurement');
        const conversionField = document.getElementById('conversion_field');
        const weightConversionInput = document.getElementById('weight_conversion');
        
        // Inicijalno proveri vrednost
        checkUnitOfMeasurement();
        
        // Dodaj event listener za promenu vrednosti
        unitOfMeasurementSelect.addEventListener('change', checkUnitOfMeasurement);
        
        function checkUnitOfMeasurement() {
            if (unitOfMeasurementSelect && conversionField && weightConversionInput) {
                if (unitOfMeasurementSelect.value === 'kg') {
                    // Umesto da sakrijemo polje, samo ga onemogućimo i postavimo vrednost na 1
                    weightConversionInput.value = '1';
                    weightConversionInput.readOnly = true;
                    conversionField.classList.add('text-muted');
                } else if (unitOfMeasurementSelect.value === 'kom' || unitOfMeasurementSelect.value === 'l') {
                    // Za kom i l možemo da omogućimo polje Težina jedinice mere u kg
                    weightConversionInput.readOnly = false;
                    conversionField.classList.remove('text-muted');
                }
            }
        }
    });
</script>

{% endblock %}