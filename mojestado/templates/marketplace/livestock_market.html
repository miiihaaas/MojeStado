{% extends "layout.html" %}
{% block content %}
<style>
    @media (max-width: 760px)  {
        .mobtable td:nth-of-type(1):before { content: "ID životinje"; }
        .mobtable td:nth-of-type(2):before { content: "Potkategorija"; }
        .mobtable td:nth-of-type(3):before { content: "Rasa"; }
        .mobtable td:nth-of-type(4):before { content: "Pol"; }
        .mobtable td:nth-of-type(5):before { content: "Trenutna masa"; }
        .mobtable td:nth-of-type(6):before { content: "Cena po kg (rsd)"; }
        .mobtable td:nth-of-type(7):before { content: "Ukupna (rsd)"; }
        .mobtable td:nth-of-type(8):before { content: "Osigurano"; }
        .mobtable td:nth-of-type(9):before { content: "Organsko"; }
        .mobtable td:nth-of-type(10):before { content: "Usluge"; }
        .mobtable td:nth-of-type(11):before { content: "Karton grla"; }
        .mobtable td:nth-of-type(12):before { content: "PG"; }
        .mobtable td:nth-of-type(13):before { content: "Lokacija"; }
    }
    #preloader { position: fixed; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .spinner { width: 50px; height: 50px; border: 5px solid #ccc; border-top-color: #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
<div id="preloader">
    <div class="spinner"></div>
</div>
<section class="page-hero livestock-{{ animal_category_id }}">
    <div class="container">
        <div class="row">
            <div class="col-md-3"></div>
            <div class="col-md-6">
                <h1 class="wht-text">Živa vaga</h1>
                <div class="home-hero-txt mb-5">
                    Živa vaga je strana koja se odnosi na sva grla stoke i svu ostalu živinu, kako u tovu, tako i odmah u prodaji. 
                    Tu možete pronaći ponudu grla svih poljoprivrednih gazdinstava.
                </div>
            </div>
            <div class="col-md-3"></div>
        </div>
    </div>
</section>
<section class="zivavaga-page mt-5" id="waitDiv">
    <div class="container">
        {% if animal_category_id == 0 %}
        <div class="row moboverflow">
            <div class="container">
                <section class="logo-carousel slider" data-arrows="true">
                    {% for category in animal_categories %}
                    <div class="slide"><a href="{{ url_for('marketplace.livestock_market', animal_category_id=category.id) }}"><img src="{{ url_for('static', filename='images/' + category.animal_category_name + '.png') }}" alt="{{ category.animal_category_name }}"><p>{{ category.animal_category_name }}</p></a></div>
                    {% endfor %}
                </section>
            </div>
        </div>
        {% else %}
        <div class="row moboverflow">
            <div class="container">
                <section class="logo-carousel slider" data-arrows="true">
                    {% for category in animal_categories %}
                    <div class="slide"><a href="{{ url_for('marketplace.livestock_market', animal_category_id=category.id) }}"><img src="{{ url_for('static', filename='images/' + category.animal_category_name + '.png') }}" alt="{{ category.animal_category_name }}"><p>{{ category.animal_category_name }}</p></a></div>
                    {% endfor %}
                </section>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2 sidebar">
                <form id='livestock' action="{{url_for('marketplace.livestock_market', animal_category_id=animal_category_id)}}" method="POST">
                    <!--<h2>Filteri</h2>-->
                    <div class="card mb-3">
                        <div class="card-header">
                            Lokacija
                        </div>
                        <div class="card-body">
                            <select class="form-select mb-2" id="municipality" name="municipality">
                            <option value="0">Sve lokacije</option>
                            {% for municipality in municipality_filter_list %}
                                <option value="{{municipality.id}}">{{municipality.municipality_name}}</option>
                            {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">
                            Potkategorije
                        </div>
                        <div class="card-body">
                            {% for subcategory in animal_subcategories %}
                            <div class="form-check form-switch">
                                {% if subcategory.id in active_subcategories %}
                                <input class="form-check-input subcategory-filter" type="checkbox" id="subcategory_{{subcategory.id}}" name="subcategory_{{subcategory.id}}" checked>
                                {% else %}
                                <input class="form-check-input subcategory-filter" type="checkbox" id="subcategory_{{subcategory.id}}" name="subcategory_{{subcategory.id}}">
                                {% endif %}
                                <label class="form-check-label" for="subcategory_{{subcategory.id}}">{{subcategory.subcategory}}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% if weight_filter %}
                    <div class="card mb-3">
                        <div class="card-header">
                            Masa
                        </div>
                        <div class="card-body">
                            {% for mass_filter in mass_filters %}
                            <div class="form-check form-switch mb-2">
                                {% if active_mass_filters and mass_filter in active_mass_filters %}
                                <input class="form-check-input" type="checkbox" id="subcategory_{{mass_filter}}" name="subcategory_{{mass_filter}}" checked>
                                {% else %}
                                <input class="form-check-input" type="checkbox" id="subcategory_{{mass_filter}}" name="subcategory_{{mass_filter}}">
                                {% endif %}
                                <label class="form-check-label" for="subcategory_{{mass_filter}}">{{mass_filter}}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    <div class="card mb-3">
                        <div class="card-header">
                            Organska proizvodnja
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch">
                                {% if organic_filter == '"on"' %}
                                <input class="form-check-input" type="checkbox" id="organic_filter" name="organic_filter" checked>
                                {% else %}
                                <input class="form-check-input" type="checkbox" id="organic_filter" name="organic_filter">
                                {% endif %}
                                <label class="form-check-label" for="organic_filter">Organski</label>
                                <!---
                                <a href="#" target="_blank" data-bs-toggle="tooltip" data-bs-placement="right" title="Detaljnije o organskoj proizvodnji">
                                    <i class="fas fa-question-circle"></i>
                                </a>
                                 -->
                                <a href="#" id="infoLink" title="Detaljnije o organskoj proizvodnji">
                                    <i class="fas fa-question-circle"></i>
                                </a>
                                <div class="popup-content" id="popupText">
                                    Organska proizvodnja podrazumeva upotrebu prirodnih resursa i metoda koji ne štete životnoj sredini...
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">
                            Osigurana grla
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch">
                                {% if insure_filter == '"on"' %}
                                <input class="form-check-input" type="checkbox" id="insure_filter" name="insure_filter" checked>
                                {% else %}
                                <input class="form-check-input" type="checkbox" id="insure_filter" name="insure_filter">
                                {% endif %}
                                <label class="form-check-label" for="insure_filter">Osigurano</label>
                            </div>
                        </div>
                    </div>
                    <!-- <div class="card mb-3">
                        <div class="card-header">
                            Količina
                        </div>
                        <div class="card-body">
                            <div class="">
                                <label class="form-label" for="quantity_filter">Količina</label>
                                <input class="form-range" type="range" min="0" max="5" id="quantity_filter" name="quantity_filter">
                            </div>
                        </div>
                    </div> -->
                </form>
            </div>
            <div class="col-md-10 table-overflow">
                <!--<p>Kategorija:</p>-->
                <h2 class="content-title">{{ animal_category.animal_category_name }}</h2>
                {% if animals %}
                <table class="table table-striped mobtable popupable">
                    <thead>
                        <tr>
                            <th>ID životinje</th>
                            <th>Potkategorija</th>
                            <th>Rasa</th>
                            <th>Pol</th>
                            <th>Trenutna masa (kg)</th>
                            <th>Cena po kg (rsd)</th>
                            <th>Ukupna cena (rsd)</th>
                            <th>Osigurano</th>
                            <th>Organsko</th>
                            <th>Usluge</th>
                            <th>Karton<br>grla</th>
                            <th>PG</th>
                            <th>Lokacija</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for animal in animals %}
                        <tr>
                            <td>
                            {% if animal.animal_id %}
                                <!--{{ animal.animal_id }}-->
                                <img src="{{ url_for('static', filename='images/id-icon.png') }}" title="{{ animal.animal_id }}" width="32" height="32" class="clickable-image">
                                <div class="popup-id">{{ animal.animal_id }}</div>
                            {% endif %}
                            </td>
                            <td>{{ animal.animal_categorization.subcategory }}</td>
                            <td>{{ animal.animal_race.animal_race_name }}</td>
                            <td>{{ animal.animal_gender }}</td>
                            <td>{{ "{:.2f}".format(animal.current_weight) }}</td>
                            <td>{{ "{:.2f}".format(animal.price_per_kg) }}</td>
                            <td>{{ "{:.2f}".format(animal.total_price) }}</td>
                            <td>
                                {% if animal.insured %}
                                    <img src="{{ url_for('static', filename='images/true-icon.png') }}" alt="Osigurano" width="32" height="32">
                                {% else %}
                                    <img src="{{ url_for('static', filename='images/false-icon.png') }}" alt="-" width="32" height="32">
                                {% endif %}
                            </td>
                            <td>
                                {% if animal.organic_animal %}
                                    <img src="{{ url_for('static', filename='images/true-icon.png') }}" alt="Organsko" width="32" height="32">
                                {% else %}
                                    <img src="{{ url_for('static', filename='images/false-icon.png') }}" alt="-" width="32" height="32">
                                {% endif %}
                            </td>
                            <td>
                                {% for service, category in animal.farm_animal.services.items() %}
                                    {% for category_id, price in category.items() %}
                                        {% if price | float > 0 and category_id | int == animal.animal_category.id %}
                                            {% if service == 'klanje' %}
                                                <img src="{{ url_for('static', filename='images/klanje-icon.png') }}" alt="Usluga klanja" width="32" height="32">
                                            {% elif service == 'obrada' %}
                                                <img src="{{ url_for('static', filename='images/obrada-icon.png') }}" alt="Usluga obrade" width="32" height="32">
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            </td>
                            <td>
                                {% if animal.cardboard %}
                                <a href="{{ url_for('static', filename='cardboards/' + animal.cardboard) }}" target="_blank" rel="noopener noreferrer" class="btn btn-primary9"><i class="fa-regular fa-clipboard"></i></a>
                                {% endif %}
                            </td>
                            <td><a href="{{ url_for('farms.farm_detail', farm_id=animal.farm_id) }}">{{ animal.farm_animal.farm_name }}</a></td>
                            <td>{{ animal.farm_animal.farm_city }}</td>
                            <td>
                                {% if animal.farm_animal.user_id != current_user.id %}
                                    {% set services = animal.farm_animal.services %}
                                    {% set klanje_value = services['klanje'].get(animal_category_id|string)|int if services and services.get('klanje') else 0 %}
                                    {% set obrada_value = services['obrada'].get(animal_category_id|string)|int if services and services.get('obrada') else 0 %}

                                    {% if services and services.get('klanje') and services['klanje'].get(animal_category_id|string) and services['klanje'][animal_category_id|string]|int > 0 %}
                                        <button class="btn btn-primary services-btn" data-bs-toggle="modal" data-bs-target="#servicesModal"
                                                data-animal-id="{{ animal.id }}"
                                                data-klanje-value="{{ klanje_value }}"
                                                data-obrada-value="{{ obrada_value }}"
                                                data-subcategory="{{ animal.animal_categorization.subcategory }}"
                                                data-breed="{{ animal.animal_race.animal_race_name }}"
                                                data-gender="{{ animal.animal_gender }}"
                                                data-current-weight="{{ animal.current_weight }}"
                                                data-price-per-kg="{{ animal.price_per_kg }}"
                                                data-total-price="{{ animal.total_price }}"
                                                data-insured="{{ 1 if animal.insured else 0 }}"
                                                data-organic="{{ 1 if animal.organic_animal else 0 }}"
                                                data-farm="{{ animal.farm_animal.farm_name }}">Kupi</button>
                                    {% else %}
                                        <a class="btn btn-primary services-btn" href="{{ url_for('main.add_animal_to_cart', animal_id=animal.id)}}">Kupi</a>
                                    {% endif %}
                                    {% if animal.intended_for == "tov" %}
                                        {% if services and services.get('klanje') and services['klanje'].get(animal_category_id|string) and services['klanje'][animal_category_id|string]|int > 0 %}
                                            <button class="btn tov-btn" data-bs-toggle="modal" data-bs-target="#tovModal" 
                                                data-animal-id="{{ animal.id }}" 
                                                data-current-weight="{{ animal.current_weight }}" 
                                                data-subcategory="{{ animal.animal_categorization.subcategory }}" 
                                                data-breed="{{ animal.animal_race.animal_race_name }}" 
                                                data-gender="{{ animal.animal_gender }}" 
                                                data-price-per-kg="{{ animal.price_per_kg }}" 
                                                data-total-price="{{ animal.current_weight * animal.price_per_kg }}" 
                                                data-insured="{{ animal.insured }}" 
                                                data-organic="{{ animal.organic_animal }}" 
                                                data-farm="{{ animal.farm_animal.farm_name }}">
                                                Tov
                                            </button>
                                        {% else %}
                                            <button class="btn tov-btn" data-bs-toggle="modal" data-bs-target="#tovModal_" 
                                                data-animal-id="{{ animal.id }}" 
                                                data-current-weight="{{ animal.current_weight }}" 
                                                data-subcategory="{{ animal.animal_categorization.subcategory }}" 
                                                data-breed="{{ animal.animal_race.animal_race_name }}" 
                                                data-gender="{{ animal.animal_gender }}" 
                                                data-price-per-kg="{{ animal.price_per_kg }}" 
                                                data-total-price="{{ animal.current_weight * animal.price_per_kg }}" 
                                                data-insured="{{ animal.insured }}" 
                                                data-organic="{{ animal.organic_animal }}" 
                                                data-farm="{{ animal.farm_animal.farm_name }}">
                                                Tov
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                    moja životinja
                                {% endif %}
                            </td>
                            
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="col-12 text-center my-5">
                    <div class="alert alert-info">
                        <h4>Ne postoje životinje za zadati kriterijum selekcije. Molimo Vas da pokušate sa drugim parametrima.</h4>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        <!-- Tov Modal -->
        <div class="modal fade" id="tovModal" tabindex="-1" aria-labelledby="tovModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="tovModalLabel">Detalji tova</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Detalji o životinji -->
                        <div class="animal-details mb-3">
                            <h6 class="border-bottom pb-2 mb-3">Detalji o životinji</h6>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="mb-1"><strong>Potkategorija:</strong> <span id="animalSubcategoryTov"></span></div>
                                    <div class="mb-1"><strong>Rasa:</strong> <span id="animalBreedTov"></span></div>
                                    <div class="mb-1"><strong>Pol:</strong> <span id="animalGenderTov"></span></div>
                                    <div class="mb-1"><strong>Trenutna masa:</strong> <span id="animalWeightTov"></span> kg</div>
                                    <div class="mb-1"><strong>Cena po kg:</strong> <span id="animalPricePerKgTov"></span> rsd</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-1"><strong>Ukupna cena:</strong> <span id="animalTotalPriceTov"></span> rsd</div>
                                    <div class="mb-1"><strong>Osigurano:</strong> <span id="animalInsuredTov"></span></div>
                                    <div class="mb-1"><strong>Organsko:</strong> <span id="animalOrganicTov"></span></div>
                                    <div class="mb-1"><strong>Farma:</strong> <span id="animalFarmTov"></span></div>
                                </div>
                            </div>
                        </div>
                        
                        <form id="tovForm" action="{{ url_for('main.add_fattening_to_chart') }}" method="POST">
                            <input type="hidden" id="animalId" name="animalId">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="currentWeight" class="form-label">Trenutna masa (kg)</label>
                                        <input type="number" class="form-control" id="currentWeight" name="currentWeight" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="desiredWeight" class="form-label">Željena masa (kg)</label>
                                        <input type="number" class="form-control" id="desiredWeight" name="desiredWeight" required min="0">
                                    </div>
                                    <div class="mb-3 form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="installmentPayment" name="installmentPayment">
                                        <label class="form-check-label" for="installmentPayment">Plaćanje na rate</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="calculatedPrice" class="form-label">Preračunata cena tova (RSD)</label>
                                        <input type="number" class="form-control" id="calculatedPrice" name="calculatedPrice" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="feedingDays" class="form-label">Preračunat broj hranidbenih dana</label>
                                        <input type="number" class="form-control" id="feedingDays" name="feedingDays" readonly>
                                    </div>
                                    <div class="mb-3" id="installmentOptionsDiv" style="display: none;">
                                        <label for="installmentOptions" class="form-label">Broj rata</label>
                                        <select class="form-select" id="installmentOptions" name="installmentOptions">
                                            <!-- Options will be dynamically populated -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <p>Za ovu životinju poljoprivredno gazdinstvo pruža sledeće usluge:</p>
                            
                            <!-- Klanje usluga -->
                            <div class="mb-3 form-check" id="slaughterServiceWrapper">
                                <input type="checkbox" class="form-check-input" id="tovSlaughterService" name="slaughterService">
                                <label class="form-check-label" for="tovSlaughterService">Klanje</label>
                            </div>
                            <!-- Obrada usluga -->
                            <div class="mb-3 form-check" id="processingServiceWrapper">
                                <input type="checkbox" class="form-check-input" id="tovProcessingService" name="processingService">
                                <label class="form-check-label" for="tovProcessingService">
                                    Obrada
                                </label>
                                <span class="info-box"><i class="fa-solid fa-info"></i>
                                    <span class="tooltip">
                                        {% if animal_category_id == 1 %}
                                        <p>Francuska obrada: svinjski but, svinjska plećka, kremenadla, vrat, las kare.</p>
                                        <p>Milanez: but, kremenadla.</p>
                                        {% elif animal_category_id == 2 %}
                                        <p>Čerek: prednji čerek (vrat sk, vrat bk, potplećka sk, potplećka bk, plećka sk, plećka bk, pauflek, rebra sk, grudi) i zadnji čerek (rozbratna sk, but sk, juneći biftek, ramstek).</p>
                                        {% elif animal_category_id == 3 %}
                                        <p>Čerek: prednjiček (vrat sk, vrat bk, potplećka sk, potplećka bk, plećka sk, plećka bk, pauflek, rebra sk, grudi) i zadnjiček (rozbratna sk, but sk, juneći biftek, ramstek).</p>
                                        {% endif %}
                                    </span>
                                </span>
                            </div>
                            <button type="submit" class="btn btn-primary">Potvrdi tov</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Tov_ Modal -->
        <div class="modal fade" id="tovModal_" tabindex="-1" aria-labelledby="tovModalLabel_" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="tovModalLabel_">Detalji tova</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Detalji o životinji -->
                        <div class="animal-details mb-3">
                            <h6 class="border-bottom pb-2 mb-3">Detalji o životinji</h6>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="mb-1"><strong>Potkategorija:</strong> <span id="animalSubcategoryTov_"></span></div>
                                    <div class="mb-1"><strong>Rasa:</strong> <span id="animalBreedTov_"></span></div>
                                    <div class="mb-1"><strong>Pol:</strong> <span id="animalGenderTov_"></span></div>
                                    <div class="mb-1"><strong>Trenutna masa:</strong> <span id="animalWeightTov_"></span> kg</div>
                                    <div class="mb-1"><strong>Cena po kg:</strong> <span id="animalPricePerKgTov_"></span> rsd</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-1"><strong>Ukupna cena:</strong> <span id="animalTotalPriceTov_"></span> rsd</div>
                                    <div class="mb-1"><strong>Osigurano:</strong> <span id="animalInsuredTov_"></span></div>
                                    <div class="mb-1"><strong>Organsko:</strong> <span id="animalOrganicTov_"></span></div>
                                    <div class="mb-1"><strong>Farma:</strong> <span id="animalFarmTov_"></span></div>
                                </div>
                            </div>
                        </div>
                        
                        <form id="tovForm_" action="{{ url_for('main.add_fattening_to_chart') }}" method="POST">
                            <input type="hidden" id="animalId_" name="animalId_">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="currentWeight_" class="form-label">Trenutna masa (kg)</label>
                                        <input type="number" class="form-control" id="currentWeight_" name="currentWeight_" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="desiredWeight_" class="form-label">Željena masa (kg)</label>
                                        <input type="number" class="form-control" id="desiredWeight_" name="desiredWeight_" required min="0">
                                    </div>
                                    <div class="mb-3 form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="installmentPayment_" name="installmentPayment_">
                                        <label class="form-check-label" for="installmentPayment_">Plaćanje na rate</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="calculatedPrice_" class="form-label">Preračunata cena tova (RSD)</label>
                                        <input type="number" class="form-control" id="calculatedPrice_" name="calculatedPrice_" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="feedingDays_" class="form-label">Preračunat broj hranidbenih dana</label>
                                        <input type="number" class="form-control" id="feedingDays_" name="feedingDays_" readonly>
                                    </div>
                                    <div class="mb-3" id="installmentOptionsDiv_" style="display: none;">
                                        <label for="installmentOptions_" class="form-label">Broj rata</label>
                                        <select class="form-select" id="installmentOptions_" name="installmentOptions_">
                                            <!-- Options will be dynamically populated -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Potvrdi tov</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Services Modal -->
        <div class="modal fade" id="servicesModal" tabindex="-1" aria-labelledby="servicesModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="servicesModalLabel">Kupovina usluga</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Detalji o životinji -->
                        <div class="animal-details mb-3">
                            <h6 class="border-bottom pb-2 mb-3">Detalji o životinji</h6>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="mb-1"><strong>Potkategorija:</strong> <span id="animalSubcategory"></span></div>
                                    <div class="mb-1"><strong>Rasa:</strong> <span id="animalBreed"></span></div>
                                    <div class="mb-1"><strong>Pol:</strong> <span id="animalGender"></span></div>
                                    <div class="mb-1"><strong>Trenutna masa:</strong> <span id="animalWeight"></span> kg</div>
                                    <div class="mb-1"><strong>Cena po kg:</strong> <span id="animalPricePerKg"></span> rsd</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-1"><strong>Ukupna cena:</strong> <span id="animalTotalPrice"></span> rsd</div>
                                    <div class="mb-1"><strong>Osigurano:</strong> <span id="animalInsured"></span></div>
                                    <div class="mb-1"><strong>Organsko:</strong> <span id="animalOrganic"></span></div>
                                    <div class="mb-1"><strong>Farma:</strong> <span id="animalFarm"></span></div>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="border-bottom pb-2 mb-3">Dostupne usluge</h6>
                        <form id="servicesForm" action="{{ url_for('main.add_services_to_chart') }}" method="POST">
                            <input type="hidden" id="serviceAnimalId" name="animalId">
                            <p>Za ovu životinju poljoprivredno gazdinstvo pruža sledeće usluge:</p>
                            
                            <!-- Klanje usluga -->
                            <div class="mb-3 form-check" id="slaughterServiceWrapper">
                                <input type="checkbox" class="form-check-input" id="slaughterService" name="slaughterService">
                                <label class="form-check-label" for="slaughterService">Klanje</label>
                            </div>
                            
                            <!-- Obrada usluga -->
                            <div class="mb-3 form-check" id="processingServiceWrapper">
                                <input type="checkbox" class="form-check-input" id="processingService" name="processingService">
                                <label class="form-check-label" for="processingService">
                                    Obrada
                                </label>
                                <span class="info-box"><i class="fa-solid fa-info"></i>
                                    <span class="tooltip">
                                        {% if animal_category_id == 1 %}
                                        <p>Francuska obrada: svinjski but, svinjska plećka, kremenadla, vrat, las kare.</p>
                                        <p>Milanez: but, kremenadla.</p>
                                        {% elif animal_category_id == 2 %}
                                        <p>Čerek: prednji čerek (vrat sk, vrat bk, potplećka sk, potplećka bk, plećka sk, plećka bk, pauflek, rebra sk, grudi) i zadnji čerek (rozbratna sk, but sk, juneći biftek, ramstek).</p>
                                        {% elif animal_category_id == 3 %}
                                        <p>Čerek: prednjiček (vrat sk, vrat bk, potplećka sk, potplećka bk, plećka sk, plećka bk, pauflek, rebra sk, grudi) i zadnjiček (rozbratna sk, but sk, juneći biftek, ramstek).</p>
                                        {% endif %}
                                    </span>
                                </span>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Kupi</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>
{% endblock content %}
{% block scripts %}
<script>
$(document).ready(function() {
    // Inicijalizacija DataTables za tabelu sa životinjama
    $('.table.table-striped.mobtable.popupable').DataTable({
        "language": {
            "search": "Pretraga:",
            "lengthMenu": "Prikaži _MENU_ zapisa po stranici",
            "zeroRecords": "Ništa nije pronađeno",
            "info": "Prikaz _START_ do _END_ od _TOTAL_ zapisa",
            "infoEmpty": "Prikaz 0 do 0 od 0 zapisa",
            "infoFiltered": "(filtrirano od ukupno _MAX_ zapisa)",
            "paginate": {
                "first": "Prva",
                "last": "Poslednja",
                "next": "Sledeća",
                "previous": "Prethodna"
            }
        },
        "pageLength": 10,
        "responsive": true,
        "columnDefs": [
            { "orderable": false, "targets": [9, 10, 13] } // Kolone koje ne mogu da se sortiraju
        ]
    });
});
</script>
<script>
    // Funkcije za drugi modalni prozor (tovModal_)
    function calculateTovDetails_() {
        var animalId = $('#animalId_').val();
        var currentWeight = parseFloat($('#currentWeight_').val());
        var desiredWeight = parseFloat($('#desiredWeight_').val());
        
        if (desiredWeight > currentWeight) {
            // AJAX poziv ka backend-u
            $.ajax({
                url: "{{ url_for('animals.calculate_fattening_details') }}",
                method: "POST",
                data: {
                    animalId: animalId,
                    currentWeight: currentWeight,
                    desiredWeight: desiredWeight
                },
                success: function(response) {
                    $('#calculatedPrice_').val(response.fattening_price.toFixed(2));
                    $('#feedingDays_').val(response.number_of_fattening_days);
                    
                    // Omoguu0107i/onemoguu0107i switch za plau0107anje na rate na osnovu broja dana hranjenja
                    var feedingDays = parseInt(response.number_of_fattening_days);
                    if (feedingDays >= 60) {
                        $('#installmentPayment_').prop('disabled', false);
                    } else {
                        disableInstallmentPayment_();
                    }
                    
                    populateInstallmentOptions_();
                },
                error: function(xhr, status, error) {
                    console.error("Greu0161ka pri izrau010dunavanju detalja tova:", error);
                    resetTovDetails_();
                }
            });
        } else {
            resetTovDetails_();
        }
        updateConfirmButton_();
    }

    function disableInstallmentPayment_() {
        $('#installmentPayment_').prop('checked', false);
        $('#installmentPayment_').prop('disabled', true);
        $('#installmentOptionsDiv_').hide();
    }

    function resetTovDetails_() {
        $('#calculatedPrice_').val('');
        $('#feedingDays_').val('');
        $('#installmentPayment_').prop('disabled', true);
    }

    function updateConfirmButton_() {
        var desiredWeight = parseFloat($('#desiredWeight_').val());
        var currentWeight = parseFloat($('#currentWeight_').val());
        var calculatedPrice = $('#calculatedPrice_').val();
        var feedingDays = $('#feedingDays_').val();
        
        var isValid = desiredWeight > currentWeight && calculatedPrice && feedingDays;
        $('#tovForm_ button[type="submit"]').prop('disabled', !isValid);
    }

    function populateInstallmentOptions_() {
        var feedingDays = parseInt($('#feedingDays_').val()) || 0;
        var calculatedPrice = parseFloat($('#calculatedPrice_').val()) || 0;
        
        // Izrau010dunaj broj moguu0107ih rata na osnovu dana hranjenja i cene
        var maxInstallments = Math.min(Math.floor(feedingDays / 30), 6);
        var minInstallmentValue = 1000; // Minimalna vrednost rate u RSD
        maxInstallments = Math.min(maxInstallments, Math.floor(calculatedPrice / minInstallmentValue));
        
        // Popuni padajuu0107i meni sa opcijama za rate
        var select = $('#installmentOptions_');
        select.empty();
        
        for (var i = 2; i <= maxInstallments; i++) {
            // Determine correct suffix based on the number
            var suffix = (i >= 2 && i <= 4) ? ' rate' : ' rata';
            select.append($('<option>', {
                value: i,
                text: i + suffix
            }));
        }
    }

    function calculateTovDetails() {
        var animalId = $('#animalId').val();
        var currentWeight = parseFloat($('#currentWeight').val());
        var desiredWeight = parseFloat($('#desiredWeight').val());
        
        if (desiredWeight > currentWeight) {
            // AJAX poziv ka backend-u
            $.ajax({
                url: "{{ url_for('animals.calculate_fattening_details') }}",
                method: "POST",
                data: {
                    animalId: animalId,
                    currentWeight: currentWeight,
                    desiredWeight: desiredWeight
                },
                success: function(response) {
                    $('#calculatedPrice').val(response.fattening_price.toFixed(2));
                    $('#feedingDays').val(response.number_of_fattening_days);
                    
                    // Omoguu0107i/onemoguu0107i switch za plau0107anje na rate na osnovu broja dana hranjenja
                    var feedingDays = parseInt(response.number_of_fattening_days);
                    if (feedingDays >= 60) {
                        $('#installmentPayment').prop('disabled', false);
                    } else {
                        disableInstallmentPayment();
                    }
                    
                    populateInstallmentOptions();
                },
                error: function(xhr, status, error) {
                    console.error("Greu0161ka pri izrau010dunavanju detalja tova:", error);
                    resetTovDetails();
                }
            });
        } else {
            resetTovDetails();
        }
        updateConfirmButton();
    }

    function disableInstallmentPayment() {
        $('#installmentPayment').prop('checked', false);
        $('#installmentPayment').prop('disabled', true);
        $('#installmentOptionsDiv').hide();
    }

    function resetTovDetails() {
        $('#calculatedPrice').val('');
        $('#feedingDays').val('');
        $('#installmentPayment').prop('disabled', true);
    }

    function updateConfirmButton() {
        var desiredWeight = parseFloat($('#desiredWeight').val());
        var currentWeight = parseFloat($('#currentWeight').val());
        var calculatedPrice = $('#calculatedPrice').val();
        var feedingDays = $('#feedingDays').val();
        
        var isValid = desiredWeight > currentWeight && calculatedPrice && feedingDays;
        $('#tovForm button[type="submit"]').prop('disabled', !isValid);
    }

    function populateInstallmentOptions() {
        var feedingDays = parseInt($('#feedingDays').val()) || 0;
        var calculatedPrice = parseFloat($('#calculatedPrice').val()) || 0;
        
        // Izrau010dunaj broj moguu0107ih rata na osnovu dana hranjenja i cene
        var maxInstallments = Math.min(Math.floor(feedingDays / 30), 6);
        var minInstallmentValue = 1000; // Minimalna vrednost rate u RSD
        maxInstallments = Math.min(maxInstallments, Math.floor(calculatedPrice / minInstallmentValue));
        
        // Popuni padajuu0107i meni sa opcijama za rate
        var select = $('#installmentOptions');
        select.empty();
        
        for (var i = 2; i <= maxInstallments; i++) {
            var suffix = (i >= 2 && i <= 4) ? ' rate' : ' rata';
            select.append($('<option>', {
                value: i,
                text: i + suffix
            }));
        }
    }
</script>
<script>
    // Funkcionalnost za drugi modalni prozor (tovModal_)
    $(document).ready(function() {
        // Tov_ modal functionality - farma ne pruža usluge
        $('.tov-btn[data-bs-target="#tovModal_"]').click(function() {
            var animalId = $(this).data('animal-id');
            var currentWeight = $(this).data('current-weight');
            
            $('#animalId_').val(animalId);
            $('#currentWeight_').val(currentWeight);

            // Reset form
            $('#tovForm_')[0].reset();
            $('#currentWeight_').val(currentWeight);
            $('#installmentOptionsDiv_').hide();
            $('#installmentPayment_').prop('disabled', true);
            // Dodajemo ovu liniju da onemogućimo dugme "Potvrdi tov" pri otvaranju modala
            $('#tovForm_ button[type="submit"]').prop('disabled', true);
            
            // Resetujemo polja za izračunate vrednosti
            $('#calculatedPrice_').val('');
            $('#feedingDays_').val('');
            $('#desiredWeight_').val('');
        })

        $('#desiredWeight_').on('input', function() {
            console.log('desiredWeight_ input event triggered');
            calculateTovDetails_();
            updateConfirmButton_();
        });

        $('#installmentPayment_').change(function() {
            if ($(this).is(':checked')) {
                $('#installmentOptionsDiv_').show();
                populateInstallmentOptions_();
            } else {
                $('#installmentOptionsDiv_').hide();
            }
        });

        // Tov modal functionality - farma pruža usluge
        $('.tov-btn[data-bs-target="#tovModal"]').click(function() {
            var animalId = $(this).data('animal-id');
            var currentWeight = $(this).data('current-weight');
            
            $('#animalId').val(animalId);
            $('#currentWeight').val(currentWeight);
            
            // Reset form
            $('#tovForm')[0].reset();
            $('#currentWeight').val(currentWeight);
            $('#installmentOptionsDiv').hide();
            $('#installmentPayment').prop('disabled', true);
            // Dodajemo ovu liniju da onemogućimo dugme "Potvrdi tov" pri otvaranju modala
            $('#tovForm button[type="submit"]').prop('disabled', true);
            
            // Resetujemo polja za izračunate vrednosti
            $('#calculatedPrice').val('');
            $('#feedingDays').val('');
            $('#desiredWeight').val('');
        });

        $('#desiredWeight').on('input', function() {
            console.log('desiredWeight input event triggered');
            calculateTovDetails();
            updateConfirmButton();
        });

        $('#installmentPayment').change(function() {
            if ($(this).is(':checked')) {
                $('#installmentOptionsDiv').show();
                populateInstallmentOptions();
            } else {
                $('#installmentOptionsDiv').hide();
            }
        });

        // Funkcionalnost za modal kupovine usluga i manipulaciju podacima o životinji
        $(document).ready(function() {
            // Services modal functionality
            $('.services-btn').click(function() {
                // Debug ispis svih data atributa
                console.log('Svi data atributi:', $(this).data());
                
                var animalId = $(this).data('animal-id');
                var klanjeValue = $(this).data('klanje-value');
                var obradaValue = $(this).data('obrada-value');
                
                // Podaci o životinji
                var subcategory = $(this).data('subcategory');
                var breed = $(this).data('breed');
                var gender = $(this).data('gender');
                var weight = $(this).data('current-weight');
                var pricePerKg = parseFloat($(this).data('price-per-kg')) || 0;
                var totalPrice = parseFloat($(this).data('total-price')) || 0;
                var insured = parseInt($(this).data('insured')) || 0;
                var organic = parseInt($(this).data('organic')) || 0;
                var farm = $(this).data('farm') || '';
                
                // Provera i formatiranje vrednosti
                insured = insured ? 'Da' : 'Ne';
                organic = organic ? 'Da' : 'Ne';
                
                // Popunjavanje podataka o životinji - sa dodatnom proverom
                $('#animalSubcategory').text(subcategory || 'Nije dostupno');
                $('#animalBreed').text(breed || 'Nije dostupno');
                $('#animalGender').text(gender || 'Nije dostupno');
                $('#animalWeight').text(weight || '0');
                $('#animalPricePerKg').text(pricePerKg.toFixed(2));
                $('#animalTotalPrice').text(totalPrice.toFixed(2));
                $('#animalInsured').text(insured);
                $('#animalOrganic').text(organic);
                $('#animalFarm').text(farm || 'Nije dostupno');
                
                console.log('Obrađeni podaci o životinji:', {
                    subcategory: subcategory,
                    breed: breed,
                    gender: gender,
                    weight: weight,
                    pricePerKg: pricePerKg,
                    totalPrice: totalPrice,
                    insured: insured,
                    organic: organic,
                    farm: farm
                });
                
                // Set animalId in the hidden input
                $('#serviceAnimalId').val(animalId);
                
                // Reset form and hide all options initially
                $('#servicesForm')[0].reset();
                $('#slaughterServiceWrapper').hide();
                $('#processingServiceWrapper').hide();

                // Show options based on values
                if (klanjeValue > 0) {
                    $('#slaughterServiceWrapper').show();
                }
                if (obradaValue > 0) {
                    $('#processingServiceWrapper').show();
                }
            });

            // Handling the relationship between the checkboxes - animal
            // Funkcionalnost za checkboxove u sva tri modala
            
            // 1. services Modal
            $('#processingService').change(function() {
                if (this.checked) {
                    // If "Obrada" is checked, ensure "Klanje" is also checked
                    $('#slaughterService').prop('checked', true);
                }
            });
        
            $('#slaughterService').change(function() {
                if (!this.checked) {
                    // If "Klanje" is unchecked, ensure "Obrada" is also unchecked
                    $('#processingService').prop('checked', false);
                }
            });
            
            // 2. Tov Modal
            $('#tovProcessingService').change(function() {
                if (this.checked) {
                    // If "Obrada" is checked, ensure "Klanje" is also checked
                    $('#tovSlaughterService').prop('checked', true);
                }
            });
        
            $('#tovSlaughterService').change(function() {
                if (!this.checked) {
                    // If "Klanje" is unchecked, ensure "Obrada" is also unchecked
                    $('#tovProcessingService').prop('checked', false);
                }
            });
            
            // 3. Tov_ Modal
            $('#processingService_').change(function() {
                if (this.checked) {
                    // If "Obrada" is checked, ensure "Klanje" is also checked
                    $('#slaughterService_').prop('checked', true);
                }
            });
        
            $('#slaughterService_').change(function() {
                if (!this.checked) {
                    // If "Klanje" is unchecked, ensure "Obrada" is also unchecked
                    $('#processingService_').prop('checked', false);
                }
            });
        });
    });
    // Funkcionalnost za tov modal kada farma pruža usluge
    $(document).ready(function() {
        // Tov modal functionality - farma pruža usluge
        $('.tov-btn[data-bs-target="#tovModal"]').click(function() {
            var animalId = $(this).data('animal-id');
            var currentWeight = $(this).data('current-weight');
            
            // Podaci o životinji
            var subcategory = $(this).data('subcategory');
            var breed = $(this).data('breed');
            var gender = $(this).data('gender');
            var weight = $(this).data('current-weight');
            var pricePerKg = parseFloat($(this).data('price-per-kg')) || 0;
            var totalPrice = parseFloat($(this).data('total-price')) || 0;
            var insured = parseInt($(this).data('insured')) || 0;
            var organic = parseInt($(this).data('organic')) || 0;
            var farm = $(this).data('farm') || '';
            
            // Provera i formatiranje vrednosti
            insured = insured ? 'Da' : 'Ne';
            organic = organic ? 'Da' : 'Ne';
            
            // Popunjavanje podataka o životinji u tovModal
            $('#animalSubcategoryTov').text(subcategory || 'Nije dostupno');
            $('#animalBreedTov').text(breed || 'Nije dostupno');
            $('#animalGenderTov').text(gender || 'Nije dostupno');
            $('#animalWeightTov').text(weight || '0');
            $('#animalPricePerKgTov').text(pricePerKg.toFixed(2));
            $('#animalTotalPriceTov').text(totalPrice.toFixed(2));
            $('#animalInsuredTov').text(insured);
            $('#animalOrganicTov').text(organic);
            $('#animalFarmTov').text(farm || 'Nije dostupno');
            
            // Popunjavanje podataka za formular
            $('#animalId').val(animalId);
            $('#currentWeight').val(currentWeight);
            
            // Reset form
            $('#tovForm')[0].reset();
            $('#currentWeight').val(currentWeight);
            $('#installmentOptionsDiv').hide();
            $('#installmentPayment').prop('disabled', true);
            // Dodajemo ovu liniju da onemogućimo dugme "Potvrdi tov" pri otvaranju modala
            $('#tovForm button[type="submit"]').prop('disabled', true);
            
            // Resetujemo polja za izračunate vrednosti
            $('#calculatedPrice').val('');
            $('#feedingDays').val('');
            $('#desiredWeight').val('');
        });

        // Tov_ modal functionality - farma ne pruža usluge
        $('.tov-btn[data-bs-target="#tovModal_"]').click(function() {
            var animalId = $(this).data('animal-id');
            var currentWeight = $(this).data('current-weight');
            
            // Podaci o životinji
            var subcategory = $(this).data('subcategory');
            var breed = $(this).data('breed');
            var gender = $(this).data('gender');
            var weight = $(this).data('current-weight');
            var pricePerKg = parseFloat($(this).data('price-per-kg')) || 0;
            var totalPrice = parseFloat($(this).data('total-price')) || 0;
            var insured = parseInt($(this).data('insured')) || 0;
            var organic = parseInt($(this).data('organic')) || 0;
            var farm = $(this).data('farm') || '';
            
            // Provera i formatiranje vrednosti
            insured = insured ? 'Da' : 'Ne';
            organic = organic ? 'Da' : 'Ne';
            
            // Popunjavanje podataka o životinji u tovModal_
            $('#animalSubcategoryTov_').text(subcategory || 'Nije dostupno');
            $('#animalBreedTov_').text(breed || 'Nije dostupno');
            $('#animalGenderTov_').text(gender || 'Nije dostupno');
            $('#animalWeightTov_').text(weight || '0');
            $('#animalPricePerKgTov_').text(pricePerKg.toFixed(2));
            $('#animalTotalPriceTov_').text(totalPrice.toFixed(2));
            $('#animalInsuredTov_').text(insured);
            $('#animalOrganicTov_').text(organic);
            $('#animalFarmTov_').text(farm || 'Nije dostupno');
            
            // Popunjavanje podataka za formular
            $('#animalId_').val(animalId);
            $('#currentWeight_').val(currentWeight);
            
            // Reset form
            $('#tovForm_')[0].reset();
            $('#currentWeight_').val(currentWeight);
            $('#installmentOptionsDiv_').hide();
            $('#installmentPayment_').prop('disabled', true);
            // Dodajemo ovu liniju da onemogućimo dugme "Potvrdi tov" pri otvaranju modala
            $('#tovForm_ button[type="submit"]').prop('disabled', true);
            
            // Resetujemo polja za izračunate vrednosti
            $('#calculatedPrice_').val('');
            $('#feedingDays_').val('');
            $('#desiredWeight_').val('');
        });

        $('#desiredWeight_').on('input', function() {
            console.log('desiredWeight_ input event triggered');
            calculateTovDetails_();
            updateConfirmButton_();
        });

        $('#installmentPayment_').change(function() {
            if ($(this).is(':checked')) {
                $('#installmentOptionsDiv_').show();
                populateInstallmentOptions_();
            } else {
                $('#installmentOptionsDiv_').hide();
            }
        });
    });
</script>
<script>
    window.addEventListener("load", function () {
        document.getElementById("preloader").style.display = "none";
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
    // Vrati scroll poziciju ako postoji
    if (sessionStorage.getItem("scrollPosition") !== null) {
        window.scrollTo(0, sessionStorage.getItem("scrollPosition"));
    }

    // Slušaj event pre nego što stranica krene da se osvežava
    window.addEventListener("beforeunload", function () {
        sessionStorage.setItem("scrollPosition", window.scrollY);
    });
});
</script>
<script>
    const link = document.getElementById('infoLink');
    const popup = document.getElementById('popupText');

    link.addEventListener('click', function(event) {
        event.preventDefault();
        popup.classList.toggle('active');
    });

    // Klik van popup-a zatvara prozor
    document.addEventListener('click', function(event) {
        if (!link.contains(event.target) && !popup.contains(event.target)) {
            popup.classList.remove('active');
        }
    });
</script>

<script>
    $(document).ready(function() {
        // Automatsko slanje forme kada se promeni bilo koji filter
        $('.form-check-input, #municipality').change(function() {
            $('#livestock').submit();
        });
    });
</script>

{% endblock scripts %}